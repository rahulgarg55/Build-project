var Event=require("./events"),cfg=require("./pbx_config"),pbx_db=require("./pbx_db"),pbx_api=require("./api/pbx_api"),dt=require("./common/datetime"),pbx_logger=require("./logger/pbx_logger"),express=require("express");const cos=require("prelude-ls")["cos"],util=require("util"),fs=require("fs"),http=require("https"),request=require("request");var logger=new pbx_logger,dateTime=new dt,dbOutput="",dbSMEid="",api=new pbx_api;function GetIvrDetail(d){this.state_name="user_ivr_state",this.enter=function(){var r;new pbx_db;if(logger.log("IMP",d.channel.id,"ivr_detail","Entering user_ivr state:user_ivr_state"),logger.log("DEB",d.channel.id,"ivr_detail","Uniqe Session ID: "+d.channel.callSessionId),d.client.on("PlaybackFinished",l),d.channel.on("ChannelDtmfReceived",i),d.language="e",1==d.non_working_day_flag)logger.log("DEB",d.channel.id,"ivr_detail","playing non working day file("+d.non_working_day_file+")"),d.user_ivr_state="NON_WORKING_DAY_IVR_TREE",e(d.currentState);else if(1==d.non_working_hour_flag)logger.log("DEB",d.channel.id,"ivr_detail","playing non working hour file("+d.non_working_hour_file+")"),d.user_ivr_state="NON_WORKING_HOUR_IVR_TREE",e(d.currentState);else if(0!=d.callProfileObj.data.ivrFlow.length){for(let e=0;e<d.callProfileObj.data.ivrFlow.length;e++)logger.log("DEB",d.channel.id,"ivr_detail","check loop temp: "+d.callProfileObj.data.ivrFlow[e].dtmf),"99"!=d.callProfileObj.data.ivrFlow[e].dtmf&&(d.gNoDtmfFlag="1",logger.log("DEB",d.channel.id,"ivr_detail","flow have other than default dtmf case, gNoDtmfFlag: "+d.gNoDtmfFlag));d.gcatId=d.callProfileObj.data.ivrFlow[d.ivr_attempts].cat_id,d.gcatDesc=d.callProfileObj.data.ivrFlow[d.ivr_attempts].cat_desc,d.gparentCatId=d.callProfileObj.data.ivrFlow[d.ivr_attempts].parent_cat_id,d.gchildrenStatus=d.callProfileObj.data.ivrFlow[d.ivr_attempts].children,d.gvalidDtmf=d.callProfileObj.data.ivrFlow[d.ivr_attempts].dtmf,d.gmediaFile=d.callProfileObj.data.ivrFlow[d.ivr_attempts].media_file.replace(".wav",""),d.geventType=d.callProfileObj.data.ivrFlow[d.ivr_attempts].event_type,d.gflowType=d.callProfileObj.data.ivrFlow[d.ivr_attempts].type,d.gflowId=d.callProfileObj.data.ivrFlow[d.ivr_attempts].id,d.gflowName=d.callProfileObj.data.ivrFlow[d.ivr_attempts].flow_name,logger.log("DEB",d.channel.id,"ivr_detail","catId: "+d.gcatId),logger.log("DEB",d.channel.id,"ivr_detail","catDesc: "+d.gcatDesc),logger.log("DEB",d.channel.id,"ivr_detail","parentCatId: "+d.gparentCatId),logger.log("DEB",d.channel.id,"ivr_detail","childrenStatus: "+d.gchildrenStatus),logger.log("DEB",d.channel.id,"ivr_detail","validDtmf: "+d.gvalidDtmf),logger.log("DEB",d.channel.id,"ivr_detail","mediaFile: "+d.gmediaFile),logger.log("DEB",d.channel.id,"ivr_detail","eventType: "+d.geventType),logger.log("DEB",d.channel.id,"ivr_detail","flowType: "+d.gflowType),logger.log("DEB",d.channel.id,"ivr_detail","flowId: "+d.gflowId),logger.log("DEB",d.channel.id,"ivr_detail","flowName: "+d.gflowName),d.ivr_attempts++,"IVR_INIT"==d.user_ivr_state&&"play"==d.gflowType&&"play"==d.geventType?(logger.log("DEB",d.channel.id,"ivr_detail","It seems default introduction need to play"),""!=d.gmediaFile&&(d.user_ivr_state="IVR_WELCOME",e(d.currentState))):"IVR_INIT"==d.user_ivr_state&&"play"==d.gflowType&&"agentGroup"==d.geventType?(logger.log("DEB",d.channel.id,"ivr_detail","It seems default introduction need to play with agentgroup call."),d.catDescAgent=d.gcatDesc,a(d.channel)):"IVR_INIT"==d.user_ivr_state&&"agentGroup"==d.geventType&&(logger.log("DEB",d.channel.id,"ivr_detail","It seems agentgroup direct callflow"),d.catDescAgent=d.gcatDesc,a(d.channel))}else logger.log("ERR",d.channel.id,"ivr_detail","Invalid API response, play thanks and disconnect the call"),d.user_ivr_state="INVALID_IVR_TREE",e(d.currentState);function e(){var e;logger.log("IMP",d.channel.id,"ivr_detail","Inside start_playback"),"IVR_WELCOME"==d.user_ivr_state?(logger.log("IMP",d.channel.id,"ivr_detail","IVR STATE (IVR_WELCOME)"),logger.log("IMP",d.channel.id,"ivr_detail","Play ("+d.gcatDesc+") MediaFile("+d.gmediaFile+")"),current_sound="sound:"+d.gmediaFile,logger.log("IMP",d.channel.id,"ivr_detail","Going to play media["+current_sound+"]"),r=null,r=d.client.Playback(),logger.log("DEB",d.channel.id,"ivr_detail","channel:",d.channel.caller),d.channel.play({media:current_sound},r,function(e,l){e&&logger.log("ERR",d.channel.id,"ivr_detail","...In Playback Handler:"+e)})):"IVR_WELCOME_AGENT_GROUP"==d.user_ivr_state?(logger.log("IMP",d.channel.id,"ivr_detail","IVR STATE (IVR_WELCOME_AGENT_GROUP)"),logger.log("IMP",d.channel.id,"ivr_detail","Play ("+d.gcatDesc+") MediaFile("+d.gmediaFile+")"),current_sound="sound:"+d.gmediaFile,logger.log("IMP",d.channel.id,"ivr_detail","Going to play media["+current_sound+"]"),r=null,r=d.client.Playback(),logger.log("DEB",d.channel.id,"ivr_detail","channel:",d.channel.caller),d.channel.play({media:current_sound},r,function(e,l){e&&logger.log("ERR",d.channel.id,"ivr_detail","...In Playback Handler:"+e)})):"INVALID_IVR_TREE"==d.user_ivr_state?(logger.log("IMP",d.channel.id,"ivr_detail","IVR STATE (INVALID_IVR_TREE)"),logger.log("IMP",d.channel.id,"ivr_detail","Play ("+d.gcatDesc+") MediaFile("+d.gmediaFile+")"),current_sound="sound:"+cfg.media.dir+"/"+cfg.media.invalid_IVRTree+"-"+d.language,logger.log("IMP",d.channel.id,"ivr_detail","Going to play media["+current_sound+"]"),r=null,r=d.client.Playback(),logger.log("DEB",d.channel.id,"ivr_detail","channel:",d.channel.caller),d.channel.play({media:current_sound},r,function(e,l){e&&logger.log("ERR",d.channel.id,"ivr_detail","...In Playback Handler:"+e)})):"NON_WORKING_DAY_IVR_TREE"==d.user_ivr_state?(logger.log("IMP",d.channel.id,"ivr_detail","IVR STATE (NON_WORKING_DAY_IVR_TREE)"),logger.log("IMP",d.channel.id,"ivr_detail","Play MediaFile("+d.non_working_day_file+")"),e=d.non_working_day_file.replace(".mp3",""),current_sound="sound:"+d.non_working_day_file_path+"/"+e,logger.log("IMP",d.channel.id,"ivr_detail","Going to play media["+current_sound+"]"),r=null,r=d.client.Playback(),logger.log("DEB",d.channel.id,"ivr_detail","channel:",d.channel.caller),d.channel.play({media:current_sound},r,function(e,l){e&&logger.log("ERR",d.channel.id,"ivr_detail","...In Playback Handler:"+e)})):"NON_WORKING_HOUR_IVR_TREE"==d.user_ivr_state?(logger.log("IMP",d.channel.id,"ivr_detail","IVR STATE (NON_WORKING_HOUR_IVR_TREE)"),logger.log("IMP",d.channel.id,"ivr_detail","Play MediaFile("+d.non_working_hour_file+")"),e=d.non_working_hour_file.replace(".mp3",""),current_sound="sound:"+d.non_working_hour_file_path+"/"+e,logger.log("IMP",d.channel.id,"ivr_detail","Going to play media["+current_sound+"]"),r=null,r=d.client.Playback(),logger.log("DEB",d.channel.id,"ivr_detail","channel:",d.channel.caller),d.channel.play({media:current_sound},r,function(e,l){e&&logger.log("ERR",d.channel.id,"ivr_detail","...In Playback Handler:"+e)})):logger.log("ERR",d.channel.id,"ivr_detail","Invalid DB response!")}function l(e){if("NON_WORKING_DAY_IVR_TREE"==d.user_ivr_state)d.endCallDescription="non working day",(1==d.non_working_day_voicemail_flag?(logger.log("DEB",d.channel.id,"ivr_detail","NON_WORKING_DAY_IVR_TREE => transferCallSession"),n):(logger.log("DEB",d.channel.id,"ivr_detail","NON_WORKING_DAY_IVR_TREE no voicemail so cleanup.."),d.calldisconnectedBy="system",t))();else if("NON_WORKING_HOUR_IVR_TREE"==d.user_ivr_state)d.endCallDescription="non working hour",(1==d.non_working_hour_voicemail_flag?(logger.log("DEB",d.channel.id,"ivr_detail","NON_WORKING_HOUR_IVR_TREE => transferCallSession"),n):(logger.log("DEB",d.channel.id,"ivr_detail","NON_WORKING_HOUR_IVR_TREE no voicemail so cleanup.."),d.calldisconnectedBy="system",t))();else if(r&&r.id==e.playback.id&&d.channel)if(logger.log("DEB",d.channel.id,"ivr_detail","Play Promot ("+d.gmediaFile+") finished"),"0"!=d.gchildrenStatus)if(logger.log("DEB",d.channel.id,"ivr_detail","One"),0!=d.callProfileObj.data.ivrFlow.length)if(logger.log("DEB",d.channel.id,"ivr_detail","two"),"0"!=d.callProfileObj.data.ivrFlow[d.ivr_attempts].dtmf){logger.log("DEB",d.channel.id,"ivr_detail","three");for(var l=d.ivr_attempts;l<d.callProfileObj.data.ivrFlow.length;l++)d.ivr_attempts=l,logger.log("DEB",d.channel.id,"ivr_detail","zeroo nahi hai yeh.........!!!!!!!!!!, ivr_attempts("+d.ivr_attempts+"), event_type("+d.callProfileObj.data.ivrFlow[d.ivr_attempts].event_type+") , dtmf("+d.callProfileObj.data.ivrFlow[d.ivr_attempts].dtmf+")"),"99"==d.callProfileObj.data.ivrFlow[l].dtmf&&"agentGroup"==d.callProfileObj.data.ivrFlow[l].event_type?(logger.log("DEB",d.channel.id,"ivr_detail","noDtmf matched with default[99] ivrtree dtmf("+d.callProfileObj.data.ivrFlow[d.ivr_attempts].dtmf+")"),d.gcatId=d.callProfileObj.data.ivrFlow[d.ivr_attempts].cat_id,d.gcatDesc=d.callProfileObj.data.ivrFlow[d.ivr_attempts].cat_desc,d.catDescAgent=d.gcatDesc,d.gparentCatId=d.callProfileObj.data.ivrFlow[d.ivr_attempts].parent_cat_id,d.gvalidDtmf=d.callProfileObj.data.ivrFlow[d.ivr_attempts].dtmf,d.gmediaFile=d.callProfileObj.data.ivrFlow[d.ivr_attempts].media_file.replace(".wav",""),d.geventType=d.callProfileObj.data.ivrFlow[d.ivr_attempts].event_type,d.gflowType=d.callProfileObj.data.ivrFlow[d.ivr_attempts].type,"1"==d.gNoDtmfFlag?(logger.log("DEB",d.channel.id,"ivr_detail","valid Dtmf case so timer started 3 sec to makecall"),setTimeout(a,3e3,d.channel)):(logger.log("DEB",d.channel.id,"ivr_detail","noDtmf so no sleep time"),a(d.channel))):logger.log("DEB",d.channel.id,"ivr_detail","no match yet acnt("+l+"), event_type("+d.callProfileObj.data.ivrFlow[l].event_type+") , dtmf("+d.callProfileObj.data.ivrFlow[l].dtmf+")")}else logger.log("DEB",d.channel.id,"ivr_detail","non zero dtmf case ("+d.callProfileObj.data.ivrFlow[d.ivr_attempts].dtmf+")");else logger.log("DEB",d.channel.id,"ivr_detail","zero ivrFlow length case ("+d.callProfileObj.data.ivrFlow.length+")");else logger.log("DEB",d.channel.id,"ivr_detail","no children case ("+d.gchildrenStatus+")");"INVALID_IVR_TREE"==d.user_ivr_state&&(logger.log("IMP",d.channel.id,"ivr_detail","Disconnecting this call"),d.calldisconnectedBy="system",d.endCallDescription="invalid call flow",t())}function a(e){logger.log("DEB",d.channel.id,"ivr_detail","noDtmf call time expired"),d.callgroupid=d.gcatDesc,"1"!=d.gValidDtmfFlag&&n()}function i(e,l){if(logger.log("DEB",d.channel.id,"ivr_detail","DTMF Event ("+e.digit+") for played file ("+d.gmediaFile+")"),0==d.non_working_hour_flag||0==d.non_working_day_flag)if(d.gValidDtmfFlag="1","0"!=d.gchildrenStatus&&"INVALID_IVR_TREE"!=d.user_ivr_state){var a="0";if("0"!=d.callProfileObj.data.ivrFlow[d.ivr_attempts].dtmf){logger.log("DEB",d.channel.id,"ivr_detail","ivr flow length("+d.callProfileObj.data.ivrFlow.length+")");for(var i=1;i<d.callProfileObj.data.ivrFlow.length;i++)logger.log("DEB",d.channel.id,"ivr_detail","here1 dtmf_-1("+d.callProfileObj.data.ivrFlow[d.ivr_attempts-1].dtmf+"), dtmf_o("+d.callProfileObj.data.ivrFlow[d.ivr_attempts].dtmf+"), call.ivr_attempts("+d.ivr_attempts+")"),logger.log("DEB",d.channel.id,"ivr_detail","a dtmf: ("+d.callProfileObj.data.ivrFlow[i].dtmf+")"),d.callProfileObj.data.ivrFlow[i].dtmf==e.digit&&(logger.log("DEB",d.channel.id,"ivr_detail","system dtmf("+e.digit+") matched with  ivrtree dtmf("+d.callProfileObj.data.ivrFlow[i].dtmf+")"),a="1",d.gcatId=d.callProfileObj.data.ivrFlow[i].cat_id,d.gcatDesc=d.callProfileObj.data.ivrFlow[i].cat_desc,d.catDescAgent=d.gcatDesc,d.gparentCatId=d.callProfileObj.data.ivrFlow[i].parent_cat_id,d.gchildrenStatus=d.callProfileObj.data.ivrFlow[i].children,d.gvalidDtmf=d.callProfileObj.data.ivrFlow[i].dtmf,d.gmediaFile=d.callProfileObj.data.ivrFlow[i].media_file.replace(".wav",""),d.geventType=d.callProfileObj.data.ivrFlow[i].event_type,d.gflowType=d.callProfileObj.data.ivrFlow[i].type);if("0"==a){logger.log("DEB",d.channel.id,"ivr_detail","here2 dtmf_-1"+d.callProfileObj.data.ivrFlow[d.ivr_attempts-1].dtmf+", dtmf_o"+d.callProfileObj.data.ivrFlow[d.ivr_attempts].dtmf+", call.ivr_attempts"+d.ivr_attempts);for(var t,i=1;i<d.callProfileObj.data.ivrFlow.length;i++)logger.log("DEB",d.channel.id,"ivr_detail","b dtmf: "+d.callProfileObj.data.ivrFlow[d.ivr_attempts].dtmf),"99"==d.callProfileObj.data.ivrFlow[i].dtmf&&(logger.log("DEB",d.channel.id,"ivr_detail","system dtmf("+e.digit+") matched with  default[99] ivrtree dtmf("+d.callProfileObj.data.ivrFlow[i].dtmf+")"),t=d.ivr_attempts-1,logger.log("DEB",d.channel.id,"ivr_detail","call.ivr_attempts("+d.ivr_attempts+"), tmpCountSub("+t+")"),logger.log("DEB",d.channel.id,"ivr_detail","dtmf("+d.callProfileObj.data.ivrFlow[i].dtmf+"), cat_id("+d.callProfileObj.data.ivrFlow[i].cat_id+") , cat_desc("+d.callProfileObj.data.ivrFlow[i].cat_desc+") , sme_id("+d.callProfileObj.data.ivrFlow[i].sme_id+") , parent_cat_id("+d.callProfileObj.data.ivrFlow[i].parent_cat_id+") , children("+d.callProfileObj.data.ivrFlow[i].children+") , event_type("+d.callProfileObj.data.ivrFlow[i].event_type+") , type("+d.callProfileObj.data.ivrFlow[i].type+")"),d.gcatId=d.callProfileObj.data.ivrFlow[i].cat_id,d.gcatDesc=d.callProfileObj.data.ivrFlow[i].cat_desc,d.catDescAgent=d.gcatDesc,d.gparentCatId=d.callProfileObj.data.ivrFlow[i].parent_cat_id,d.gchildrenStatus=d.callProfileObj.data.ivrFlow[i].children,d.gvalidDtmf=d.callProfileObj.data.ivrFlow[i].dtmf,d.gmediaFile=d.callProfileObj.data.ivrFlow[i].media_file.replace(".wav",""),d.geventType=d.callProfileObj.data.ivrFlow[i].event_type,d.gflowType=d.callProfileObj.data.ivrFlow[i].type,a="2")}"0"==a&&logger.log("ERR",d.channel.id,"ivr_detail","No match with any dtmf, Error senario!"),logger.log("DEB",d.channel.id,"ivr_detail","catId: "+d.gcatId),logger.log("DEB",d.channel.id,"ivr_detail","catDesc: "+d.gcatId),logger.log("DEB",d.channel.id,"ivr_detail","catDescAgent: "+d.catDescAgent),logger.log("DEB",d.channel.id,"ivr_detail","parentCatId: "+d.gparentCatId),logger.log("DEB",d.channel.id,"ivr_detail","childrenStatus: "+d.gchildrenStatus),logger.log("DEB",d.channel.id,"ivr_detail","validDtmf: "+d.gvalidDtmf),logger.log("DEB",d.channel.id,"ivr_detail","mediaFile: "+d.gmediaFile),logger.log("DEB",d.channel.id,"ivr_detail","eventType: "+d.geventType),logger.log("DEB",d.channel.id,"ivr_detail","flowType: "+d.gflowType),"play"==d.geventType&&"play"==d.gflowType||("agentGroup"==d.geventType?(logger.log("DEB",d.channel.id,"ivr_detail","agentGroup & dtmf"),"dtmf"==d.gflowType?!e.digit||d.gvalidDtmf!=e.digit&&"99"!=d.gvalidDtmf?logger.log("IMP",d.channel.id,"ivr_detail","Received dtmf("+e.digit+") not matched with IVRTree dtmf("+d.gvalidDtmf+")"):(r&&d.channel&&(logger.log("DEB",d.channel.id,"ivr_detail","stopping playing file ("+d.gmediaFile+")"),r.stop()),n()):"play"==d.gflowType?(r&&d.channel&&(logger.log("DEB",d.channel.id,"ivr_detail","stopping playing file ("+d.gmediaFile+")"),r.stop()),n()):logger.log("ERR",d.channel.id,"ivr_detail","Invalid flowtype of IVRTree state ("+d.user_ivr_state+")")):logger.log("ERR",d.channel.id,"ivr_detail","Invalid eventType of IVRTree state ("+d.user_ivr_state+")"))}else logger.log("ERR",d.channel.id,"ivr_detail","Invalid DB output")}else"99"==d.gvalidDtmf&&"0"==d.gchildrenStatus?n():logger.log("ERR",d.channel.id,"ivr_detail","No children found in IVR Tree");else logger.log("DEB",d.channel.id,"ivr_detail","Active -> non_working_hour_flag("+d.non_working_hour_flag+") or non_working_day_flag("+d.non_working_day_flag+"), So Ignore DTMF")}function n(){d.IvrEndTime=dateTime.getAgentDateTime(),d.IvrCallDuration=dateTime.calculateDuration(d.callstartDateTime,d.IvrEndTime),logger.log("DEB",d.channel.id,"ivr_detail","||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||"),logger.log("DEB",d.channel.id,"ivr_detail","IvrCallDuration("+d.IvrCallDuration+")"),logger.log("DEB",d.channel.id,"ivr_detail","||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||"),d.finalDTMF=d.gvalidDtmf,logger.log("DEB",d.channel.id,"ivr_detail","finalDTMF("+d.finalDTMF+")"),logger.log("IMP",d.channel.id,"ivr_detail","Inside clearprocess function"),d.channel.removeListener("ChannelDtmfReceived",i),d.channel.removeListener("PlaybackFinished",l),d.channel.removeListener("ChannelDtmfReceived",i),d.channel.removeListener("PlaybackFinished",l),d.client.removeListener("PlaybackFinished",l),"NON_WORKING_DAY_IVR_TREE"==d.user_ivr_state||"NON_WORKING_HOUR_IVR_TREE"==d.user_ivr_state?(d.callvoicemailstate="SIMPLE_PLAY_WELCOME_VM",logger.log("DEB",d.channel.id,"ivr_detail","State-Machine Update to ==> [Event.VOICEMAIL]"),d.state_machine.change_state(Event.VOICEMAIL)):"0"<d.parallelRingingChannels?(logger.log("DEB",d.channel.id,"ivr_detail","State-Machine Update to ==> [Event.IVR_RECEIVED_PR]"),d.state_machine.change_state(Event.IVR_RECEIVED_PR)):(logger.log("DEB",d.channel.id,"ivr_detail","State-Machine Update to ==> [Event.IVR_RECEIVED]"),d.state_machine.change_state(Event.IVR_RECEIVED))}function t(){logger.log("IMP",d.channel.id,"ivr_detail","Inside cleanup function"),d.channel.removeListener("ChannelHangupRequest",o),d.channel.hangup(function(e){})}function o(e,l){logger.log("IMP",d.channel.id,"ivr_detail","Inside on_hangup"),logger.log("DEB",l.id,"ivr_detail","1 calldisconnectedBy:"+l.calldisconnectedBy),logger.log("DEB",l.id,"ivr_detail","2 calldisconnectedBy:"+d.calldisconnectedBy),logger.log("DEB",l.id,"ivr_detail","3 calldisconnectedBy:"+d.channel.calldisconnectedBy),t(),logger.log("DEB",d.channel.id,"ivr_detail","State-Machine Update to ==> [Event.HANGUP]"),d.state_machine.change_state(Event.HANGUP)}}}module.exports=GetIvrDetail;